const allQuestionArr = [
    {
        "question": " 专转 砖专?",
        "options": [
            "专砖",
            "转 ",
            "驻",
            "专 砖注"
        ],
        "correct_answer": "专砖"
    },
    {
        "question": " 住驻专 专砖 拽 转专?",
        "options": [
            "1",
            "2",
            "3",
            "5"
        ],
        "correct_answer": "2"
    },
    {
        "question": "  砖转  转?",
        "options": [
            "驻",
            "专",
            "专",
            ""
        ],
        "correct_answer": "专"
    },
    {
        "question": " 砖 拽 转 砖专?",
        "options": [
            "1948",
            "1967",
            "1956",
            "1945"
        ],
        "correct_answer": "1948"
    },
    {
        "question": " 转 转 住驻专 '专 驻专'?",
        "options": [
            "'.拽. 专",
            "'.专.专. 拽",
            "'专' 专.专. 专",
            "住 拽"
        ],
        "correct_answer": "'.拽. 专"
    },
    {
        "question": " 砖驻 专转 转专 注?",
        "options": [
            "转",
            "住驻专转",
            "住转",
            ""
        ],
        "correct_answer": "住转"
    },
    {
        "question": "  转  拽专 转专 砖砖?",
        "options": [
            "",
            "专 专抓",
            "",
            " "
        ],
        "correct_answer": " "
    },
    {
        "question": "   转专 注?",
        "options": [
            " 转",
            " ",
            " 住驻",
            "拽住 砖拽"
        ],
        "correct_answer": "拽住 砖拽"
    },
    {
        "question": " 住 转 砖 ?",
        "options": [
            "H2O",
            "CO2",
            "O2",
            "CH4"
        ],
        "correct_answer": "H2O"
    },
    {
        "question": " 砖 砖  拽 转专 注?",
        "options": [
            "砖",
            "拽",
            "住 专",
            "转拽"
        ],
        "correct_answer": "转拽"
    },
    {
        "question": " 爪专 转  ?",
        "options": [
            "专  爪'",
            "驻 驻拽住",
            "住  ",
            "专驻"
        ],
        "correct_answer": "专  爪'"
    },
    {
        "question": " 砖 转 专砖  注 专?",
        "options": [
            "1965",
            "1969",
            "1972",
            "1959"
        ],
        "correct_answer": "1969"
    },
    {
        "question": " 爪 转 驻?",
        "options": [
            "专 砖",
            "转住 住",
            "住专 专 ",
            "拽 住"
        ],
        "correct_answer": "住专 专 "
    },
    {
        "question": "  爪转 注专 驻专?",
        "options": [
            "爪专驻转",
            "",
            "住驻专",
            "专"
        ],
        "correct_answer": "爪专驻转"
    },
    {
        "question": "  住专转  驻住?",
        "options": [
            "驻驻",
            "",
            "爪",
            "住驻"
        ],
        "correct_answer": "爪"
    },
    {
        "question": " 砖转   转专 砖?",
        "options": [
            "驻专拽",
            "住",
            "专驻",
            "专拽 爪驻转"
        ],
        "correct_answer": "住"
    },
    {
        "question": " 住驻专 注爪转 祝  专?",
        "options": [
            "206",
            "201",
            "220",
            "186"
        ],
        "correct_answer": "206"
    },
    {
        "question": "   拽  转专 注?",
        "options": [
            "驻",
            "专砖 转",
            "转 ",
            "'专驻"
        ],
        "correct_answer": "转 "
    },
    {
        "question": " 注专 专 砖 ?",
        "options": [
            "",
            "专",
            "爪",
            "驻专爪"
        ],
        "correct_answer": "专"
    },
    {
        "question": "  专转 转专 注?",
        "options": [
            "驻",
            " ",
            "住专",
            "住"
        ],
        "correct_answer": " "
    },
    {
        "question": "  专砖 砖 专砖 砖 砖专?",
        "options": [
            " -专",
            " 专",
            "爪拽 专",
            " "
        ],
        "correct_answer": " -专"
    },
    {
        "question": " 专 注砖  转专 注?",
        "options": [
            "专 注砖 转",
            "专 驻'",
            " 拽",
            "专 注砖 拽"
        ],
        "correct_answer": " 拽"
    },
    {
        "question": " 砖驻转 转转 驻驻专转 转专 注?",
        "options": [
            "Python",
            "Java",
            "C#",
            "JavaScript"
        ],
        "correct_answer": "JavaScript"
    },
    {
        "question": " 转 转  ''?",
        "options": [
            " 砖拽住驻专",
            "'专' 专",
            "爪'专住 拽住",
            " 住"
        ],
        "correct_answer": " 砖拽住驻专"
    },
    {
        "question": "  专 转专 注?",
        "options": [
            "专住",
            "抓",
            "住住",
            "驻"
        ],
        "correct_answer": "抓"
    },
    {
        "question": "  爪转 注专  专拽?",
        "options": [
            "专爪转 专转",
            "拽",
            "",
            "拽住拽"
        ],
        "correct_answer": "专爪转 专转"
    },
    {
        "question": " 注 专砖 砖 驻?",
        "options": [
            "专",
            "专",
            "",
            "驻"
        ],
        "correct_answer": ""
    },
    {
        "question": " 砖转 爪转 爪专?",
        "options": [
            "住",
            "驻专拽",
            "专驻",
            "专拽 专转"
        ],
        "correct_answer": "驻专拽"
    },
    {
        "question": " 砖 转专砖 专爪 专?",
        "options": [
            "1992",
            "1995",
            "1998",
            "2000"
        ],
        "correct_answer": "1995"
    },
    {
        "question": "  砖?",
        "options": [
            "住驻专",
            "拽",
            "驻拽",
            "爪专"
        ],
        "correct_answer": "驻拽"
    },
    {
        "question": " 砖专 砖专 砖 专 专砖?",
        "options": [
            "",
            "",
            "",
            ""
        ],
        "correct_answer": ""
    },
    {
        "question": " 拽专 专 住?",
        "options": [
            " 拽专",
            " 转",
            " 拽",
            "专 住"
        ],
        "correct_answer": " 拽专"
    },
    {
        "question": "   拽 转专 注 住 ?",
        "options": [
            "",
            "驻",
            " 专",
            "专"
        ],
        "correct_answer": ""
    },
    {
        "question": "  爪 驻爪?",
        "options": [
            "",
            "爪专驻转",
            "专爪转 专转",
            "住驻专"
        ],
        "correct_answer": ""
    },
    {
        "question": " 住驻专  专 注?",
        "options": [
            "专 驻专",
            "转\"",
            " 砖",
            "砖专 注转"
        ],
        "correct_answer": "转\""
    },
    {
        "question": "  转 转 砖专 ' ''?",
        "options": [
            "住",
            "住 驻专住",
            " ",
            "' "
        ],
        "correct_answer": "住"
    },
    {
        "question": "  爪转 注专 专?",
        "options": [
            "专",
            "爪专驻转",
            "",
            ""
        ],
        "correct_answer": "专"
    },
    {
        "question": " 爪注 砖 拽砖转?",
        "options": [
            "5",
            "6",
            "7",
            "8"
        ],
        "correct_answer": "7"
    },
    {
        "question": " 转转  砖 爪 砖 注拽?",
        "options": [
            "50 砖",
            "75 砖",
            "100 砖",
            "150 砖"
        ],
        "correct_answer": "150 砖"
    },
    {
        "question": " 砖 转 转 注 砖?",
        "options": [
            "1914",
            "1939",
            "1945",
            "1923"
        ],
        "correct_answer": "1939"
    },
    {
        "question": "  专  砖拽  注 砖转 2022?",
        "options": [
            " 住",
            "专住 专",
            "拽 驻",
            "拽专 "
        ],
        "correct_answer": "拽专 "
    },
    {
        "question": "   转专 注 砖?",
        "options": [
            "专爪转 专转",
            "拽",
            "专住",
            "专"
        ],
        "correct_answer": "专住"
    },
    {
        "question": " 拽转 砖 砖注?",
        "options": [
            "50",
            "60",
            "70",
            "80"
        ],
        "correct_answer": "60"
    },
    {
        "question": " 砖驻  专砖转 专?",
        "options": [
            "注专转",
            "专拽转",
            "驻专住转",
            "注专转"
        ],
        "correct_answer": "驻专住转"
    },
    {
        "question": "  专转 转专 注?",
        "options": [
            "住专",
            "专 驻专拽",
            "爪'",
            "专"
        ],
        "correct_answer": "专"
    },
    {
        "question": " 驻专  砖 砖专?",
        "options": [
            "转驻",
            "转专",
            "转",
            "专"
        ],
        "correct_answer": "转专"
    },
    {
        "question": "  砖爪 驻 转 ?",
        "options": [
            " ",
            " 转",
            " 住驻",
            " 砖专"
        ],
        "correct_answer": " 转"
    },
    {
        "question": " 砖转 爪转 专?",
        "options": [
            "专拽 爪驻转",
            "住",
            "专拽 专转",
            "驻专拽"
        ],
        "correct_answer": "专拽 专转"
    },
    {
        "question": " 砖拽 驻驻专 转专 注?",
        "options": [
            "转",
            "拽驻",
            "",
            "抓 转驻"
        ],
        "correct_answer": ""
    },
    {
        "question": "  砖 砖 专?",
        "options": [
            "356",
            "365",
            "366",
            "364"
        ],
        "correct_answer": "365"
    },
    {
        "question": " 砖 拽 专?",
        "options": [
            "1989",
            "1991",
            "1969",
            "2000"
        ],
        "correct_answer": "1989"
    },
    {
        "question": "   砖 ?",
        "options": [
            "驻爪",
            "驻驻",
            "住拽",
            "拽住拽住"
        ],
        "correct_answer": "住拽"
    },
    {
        "question": " 专  转专 驻专拽?",
        "options": [
            "专 住",
            "专 驻'",
            "专 拽'专",
            "专 拽"
        ],
        "correct_answer": "专 拽'专"
    },
    {
        "question": " 砖 砖 注专 注转拽 转专 注 砖爪转 砖专?",
        "options": [
            "转 ",
            "驻",
            "专砖",
            "专"
        ],
        "correct_answer": "专"
    },
    {
        "question": " 注专 专砖 砖拽 砖专 专 拽 ?",
        "options": [
            "砖",
            "转 ",
            "专",
            "转"
        ],
        "correct_answer": "砖"
    },
    {
        "question": "  爪 爪驻 砖专?",
        "options": [
            "专转",
            " ",
            " 转",
            " 住祝"
        ],
        "correct_answer": "专转"
    },
    {
        "question": " 砖 转 住 砖  砖专 爪专?",
        "options": [
            "1973",
            "1979",
            "1981",
            "1993"
        ],
        "correct_answer": "1979"
    },
    {
        "question": "  砖 砖砖 砖 转 砖专?",
        "options": [
            " 专爪",
            "驻专 拽爪专",
            "爪拽 ",
            "注专 爪"
        ],
        "correct_answer": " 专爪"
    },
    {
        "question": " 祝   转 拽  转专 注?",
        "options": [
            " 转",
            "专转",
            " 砖专",
            " "
        ],
        "correct_answer": " "
    },
    {
        "question": " 砖 砖 专 专 转专 砖专?",
        "options": [
            "专转 专",
            "专转 专 爪驻",
            "专转 爪 砖专",
            "专转 "
        ],
        "correct_answer": "专转 专"
    },
    {
        "question": " 注专 爪  砖专?",
        "options": [
            "转 ",
            "专砖",
            "驻",
            "专 砖注"
        ],
        "correct_answer": "专砖"
    },
    {
        "question": " 砖 拽 转 专转?",
        "options": [
            "1965",
            "1970",
            "1975",
            "1985"
        ],
        "correct_answer": "1965"
    },
    {
        "question": " 转 注  转 专转?",
        "options": [
            "住",
            " 转专转",
            "注 砖",
            "转拽砖专转"
        ],
        "correct_answer": " 转专转"
    },
    {
        "question": " 注专 拽转 转 专转?",
        "options": [
            "专",
            "注驻",
            "拽专转 砖",
            "注拽 专"
        ],
        "correct_answer": "注拽 专"
    },
    {
        "question": "   爪转 转 专转?",
        "options": [
            " ",
            "专转",
            " 转",
            " 住祝"
        ],
        "correct_answer": "专转"
    },
    {
        "question": " 砖  砖 转 专转?",
        "options": [
            " 拽转 专转 注拽 专",
            " 专转 专转",
            " 转 专转",
            "转 专转 注"
        ],
        "correct_answer": " 拽转 专转 注拽 专"
    },
    {
        "question": " 驻拽转 砖 转 专转?",
        "options": [
            "3",
            "4",
            "5",
            "6"
        ],
        "correct_answer": "5"
    },
    {
        "question": " 爪注  砖 转 专转?",
        "options": [
            "",
            "",
            "专拽",
            "爪"
        ],
        "correct_answer": ""
    },
    {
        "question": " 驻拽 砖 驻转 转 专转 砖转 2020?",
        "options": [
            "注 砖",
            "住转 砖",
            " 注专转 专转",
            "驻住"
        ],
        "correct_answer": " 注专转 专转"
    },
    {
        "question": " 专 拽转 爪注 转 专转 转专?",
        "options": [
            "转专 专砖 ",
            "转专 专砖 砖",
            "转专 专砖, 砖 砖砖",
            " 转注 "
        ],
        "correct_answer": "转专 专砖 砖"
    },
    {
        "question": " 砖 砖 住驻专 专转 转 专转?",
        "options": [
            "住驻专转 专转",
            "住驻专 专转 注状砖 专拽 砖",
            "住驻专转 注拽 专",
            "住驻专 专转 注状砖  砖"
        ],
        "correct_answer": "住驻专 专转 注状砖 专拽 砖"
    },
    {
        "question": " 爪注  砖  ?",
        "options": ["", "", "专拽", "爪"],
        "correct_answer": ""
    },
    {
        "question": " 砖驻 专转 转专 注?",
        "options": ["转", "住驻专转", "住转", "爪专驻转转"],
        "correct_answer": "住转"
    },
    {
        "question": "  专 砖?",
        "options": ["驻拽", "砖专专", "拽", "爪专"],
        "correct_answer": "驻拽"
    },
    {
        "question": "  砖 砖注?",
        "options": ["5", "6", "7", "8"],
        "correct_answer": "7"
    },
    {
        "question": " 砖转 爪转 转 砖专?",
        "options": ["专驻", "驻专拽", "住", "专拽"],
        "correct_answer": "住"
    },
    {
        "question": " 驻专  转 转专?",
        "options": ["", "转驻", "转驻", ""],
        "correct_answer": "转驻"
    },
    {
        "question": "   转专 注 砖?",
        "options": ["专住", "住", "专爪转 专转", "拽"],
        "correct_answer": "专住"
    },
    {
        "question": " 祝 砖 拽专 转专 专 专抓?",
        "options": ["专", "", "", "砖砖"],
        "correct_answer": "专"
    },
    {
        "question": " 砖 砖 砖?",
        "options": ["10", "11", "12", "13"],
        "correct_answer": "12"
    },
    {
        "question": " 爪 转 专转 砖?",
        "options": ["转住 住", "专 砖", "拽 住", "住专 专 "],
        "correct_answer": "转住 住"
    },
    {
        "question": " 注专 专 砖 爪专驻转?",
        "options": ["专", "", "驻专", "专"],
        "correct_answer": "驻专"
    },
    {
        "question": "  砖转  转?",
        "options": ["专", "驻", "专", ""],
        "correct_answer": "专"
    },
    {
        "question": " 砖转  拽 转专 砖?",
        "options": ["驻专拽", "住", "住专", "专驻"],
        "correct_answer": "住专"
    },
    {
        "question": "    转专 注?",
        "options": ["专砖 转", "驻", "转 ", "'专驻"],
        "correct_answer": "转 "
    },
    {
        "question": " 注 专砖 砖 驻?",
        "options": ["专", "", "专", "驻"],
        "correct_answer": ""
    },
    {
        "question": "  专转 转专 注?",
        "options": [" ", "驻", "住专", "住"],
        "correct_answer": " "
    },
    {
        "question": " 砖转 砖 注?",
        "options": ["4", "5", "6", "7"],
        "correct_answer": "7"
    },
    {
        "question": " 注专 专 砖 ?",
        "options": ["驻专", "专", "", "专"],
        "correct_answer": ""
    },
    {
        "question": " 转转 砖转 ?",
        "options": ["专", "住祝", "", ""],
        "correct_answer": "专"
    },
    {
        "question": "    转专 注?",
        "options": [" 转", " ", " ", " 砖专"],
        "correct_answer": " "
    }
]

const initialState = {
    gameState: 'init',
    time: 90,
    questionCnt: 1,
    corrAnswersCnt: 0,
    name: "",
    score: getBestPlayer(),
    questionData: {},
    isPressed: false,
    resetTimeout: 3
}

function shuffleQuestions() {
    for (let i = allQuestionArr.length - 1; i > 0; i--) {
        let rnd = Math.floor(Math.random() * (i + 1))
        let temp = allQuestionArr[i]
        allQuestionArr[i] = allQuestionArr[rnd]
        allQuestionArr[rnd] = temp
    }
}
function setLocalStorage(keyName, data) {
    localStorage.setItem(keyName, JSON.stringify(data));
}
function getLocalStorage(keyName) {
    return JSON.parse(localStorage.getItem(keyName))
}
function getById(elId) {
    return document.getElementById(elId)
}
function getAllByClass(className) {
    return document.querySelectorAll(`.${className}`)
}




const bestScoreEl = getById('best-score');
const bestPlayerEl = getById('best-player');
const currPlayerEl = getById('curr-player')
const currScoreEl = getById('curr-score')

const questionEl = getById('question')
const questionNumEl = getById('question-number')
const allAnswersEl = getAllByClass('answers')
const allSquaresEl = getAllByClass('square')
const allAnswersContainers = getAllByClass('answer-container')

const modal = getById('dialog')
let modalContainer = getById('dialog-container')

const timer = getById('timer')

document.addEventListener('keypress', initPress)
function initPress(e) {
    document.removeEventListener('keypress', initPress)
    modalContainer.remove()
    startGame();
}

function getBestPlayer() {
    let bScore = 0
    const gamesInfo = getLocalStorage('games-info')
    if (!gamesInfo) return bScore
    gamesInfo.map((el) => {
        bScore = Math.max(bScore, el.score)
    }
    )
    return bScore
}

function toggleTimeAlert() {
    timer.classList.toggle('low-time')
}

function getQuestion(num) {
    return allQuestionArr[num - 1];
}

function handleKeyDown(e) {
    switch (e.key) {
        case 'a':
            //need to fix btn
            initialState.gameState !== 'init' && !initialState.isPressed && checkAnswer(0)
            initialState.gameState === 'init' && startGame()
            break;
        case 'b':
            initialState.gameState !== 'init' && !initialState.isPressed && checkAnswer(1)
            break;
        case 'c':
            initialState.gameState !== 'init' && !initialState.isPressed && checkAnswer(2)
            break;
        case 'd':
            initialState.gameState !== 'init' && !initialState.isPressed && checkAnswer(3)
            break;
        default:
            break;
    }

}
function checkAnswer(pressedBtnNum) {
    let isCorr = false
    initialState.isPressed = true;
    if (initialState.questionData.options[pressedBtnNum] === initialState.questionData.correct_answer) {
        initialState.corrAnswersCnt++;
        initialState.score += 10;
        isCorr = true;
        allSquaresEl[pressedBtnNum].classList.add('correct')
        allAnswersContainers[pressedBtnNum].classList.add('correct-answer')
    } else {
        allAnswersContainers[pressedBtnNum].classList.add('wrong')
    }
    initialState.questionCnt++;

    initialState.questionData = getQuestion(initialState.questionCnt)

    updateUi(pressedBtnNum, isCorr)

}
function countDown() {
    let lowerThenTen
    if (initialState.gameState === 'running') {

        const timeHandler = setInterval(() => {
            let min = Math.floor(initialState.time / 60)
            let sec = (initialState.time % 60)

            timer.innerText = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`
            if (initialState.time <= 10 && !lowerThenTen) {
                toggleTimeAlert()
                lowerThenTen = true
            }
            if (!min && !sec && initialState.gameState !== 'end-game') {
                clearInterval(timeHandler)
                endGame();

            }
            else {
                initialState.time--;
            }
        }, 1000)
    }
}

function endGameModal(text) {
    const modalElement = `
                        <div id="dialog-container">
                        <dialog id="dialog" open>
                        <h3>砖拽 专</h3>
                        <p class="dialog-p">
                        ${initialState.questionCnt > 1 ?
            `爪转 注转 注 ${initialState.corrAnswersCnt} 转 ${initialState.questionCnt - 1}`
            :
            `爪转 注转 注 ${initialState.corrAnswersCnt} 转 ${initialState.questionCnt}`
        }
                        </p>
                        <p class="dialog-p">${text}</p>
                        <button id="dialog-btn" onclick="initPress"> 砖拽 砖
                        <span id="reset-timeout">注 ${initialState.resetTimeout}</span> </button>
                        </dialog>
                        </div>
                        `

    document.body.insertAdjacentHTML("afterbegin", modalElement)
    modalContainer = getById("dialog-container")
}


function startGame() {
    document.addEventListener('keypress', handleKeyDown)
    shuffleQuestions()
    initialState.questionData = getQuestion(initialState.questionCnt)
    showQuestion()
    currPlayerEl.innerText = "砖专 砖专"
    currScoreEl.innerText = 0
    initialState.gameState = 'running'
    countDown()

}


function showQuestion() {
    questionNumEl.innerHTML = initialState.questionCnt
    questionEl.innerHTML = initialState.questionData.question
    allAnswersEl.forEach((el, i) => el.innerHTML = initialState.questionData.options[i])
}

function endGame() {
    if ((initialState.corrAnswersCnt === initialState.questionCnt - 1) && initialState.questionCnt > 1) {
        endGameModal(`! 注转 注  砖转 爪 , 爪专转 ${initialState.score} 拽转`)
    }
    if (initialState.corrAnswersCnt > 0 && initialState.corrAnswersCnt < (initialState.questionCnt / 2) + 1) {
        endGameModal(` , 注  砖 专砖 爪转 爪专转 ${initialState.score} 拽转`)
    }
    if (initialState.corrAnswersCnt === 0) {
        endGameModal(`   爪 ?  驻注 `)
    }

    toggleTimeAlert()
    initialState.gameState = 'init'
    initialState.time = 90
    initialState.questionCnt = 1
    initialState.corrAnswersCnt = 0
    initialState.name = ""
    initialState.score = getBestPlayer()
    initialState.questionData = {
        "question": ".",
        "options": [
            ".",
            ".",
            ".",
            "."
        ],
        "correct_answer": "."
    }
    initialState.isPressed = false

    document.removeEventListener('keypress', handleKeyDown)
    updateUi([0, 1, 2, 3], false)

    const resetTimeoutEl = getById("reset-timeout")
    const timeoutBtn = setInterval(() => {
        if (initialState.resetTimeout === 0) {
            document.addEventListener('keypress', initPress)
            clearInterval(timeoutBtn)
        }
        if (initialState.resetTimeout > 0) {
            initialState.resetTimeout--
        }
        resetTimeoutEl.innerHTML = initialState.resetTimeout > 0 ? `注 ${initialState.resetTimeout}` : ''
    }, 1000)
}

function updateUi(pressedNum = [], isCorrect, timeOut = 1000) {
    setTimeout(() => {
        initialState.isPressed = false;
        if (isCorrect && !pressedNum.length) {
            allSquaresEl[pressedNum].classList.remove('correct');
            allAnswersContainers[pressedNum].classList.remove('correct-answer')
            currScoreEl.innerHTML = initialState.score;
        }
        if (!isCorrect && !pressedNum.length) {
            allAnswersContainers[pressedNum].classList.remove('wrong')
        }
        if (pressedNum.length) {
            allSquaresEl.forEach(el => el.classList.remove('correct'))
            allAnswersContainers.forEach(el => {
                el.classList.remove('correct-answer')
                el.classList.remove('wrong')
            })
            timer.innerHTML = '01:30'
        }
        showQuestion()
    }, timeOut)

}
